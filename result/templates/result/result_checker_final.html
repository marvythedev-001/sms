{% extends 'result/layout.html' %}
{% load static %}
{% load result_extras %}
{% block 'main' %}

<div class="col-xl-12 col-lg-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">RESULT CHECKER</h4>
            </div>
            <div class="card-body">
                <div class="basic-form">
                    <form class="retrievalForm" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="mb-3 col-md-6">
                                <label class="form-label">Academic Session</label>
                                <select name="academic-session" id="inputSession" data="food rice meat" class="default-select form-control wide">
                                    <option value="" selected>--- SELECT SESSION ---</option>
                                    {% for sess in sessions %}
                                    <option value={{sess.id}}>{{sess.name | upper}}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div id="termSelectContainer" class="mb-3 col-md-6">
                                <label class="form-label">Academic Term</label>
                                <select name="academic-term" id="inputTerm" class="default-select form-control wide">
                                    <option selected>--- SELECT TERM ---</option>
                                </select>
                            </div>

                            <div class="mb-3 col-md-4">
                                <label class="form-label">Class Category</label>
                                <select name="student-class-category" id="inputClassCategory" class="default-select form-control wide">
                                    <option selected value="">--- SELECT CLASS CATEGORY ---</option>
                                    {% for ctg in class_categories %}
                                    <option value="{{ctg}}">{{ctg|upper}}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div id="classSelectContainer" class="mb-3 col-md-4">
                                <label class="form-label">Class</label>
                                <select name="student-class" id="inputClass" class="default-select form-control wide">
                                    <option selected value="">--- SELECT CLASS ---</option>
                                </select>
                            </div>

                            <div id="classArmSelectContainer" class="mb-3 col-md-4">
                                <label class="form-label">Class Arm</label>
                                <select name="student-class-arm" id="inputClassArm" class="default-select form-control wide">
                                    <option selected value="">--- SELECT CLASS ARM ---</option>
                                    <option value=1>RUBY</option>
                                    <option value=2>TOPAZ</option>
                                    <option value=3>SILVER</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-end">Check Result</button>
                    </form>
                </div>
            </div>
        </div>
</div>


        <div class="col-xl-12 col-xxl-12">
            <div class="row">
                <div class="col-xl-4 col-sm-4">
                    <div class="card ds-2">
                        <div class="card-body">
                            <div class="">
                                <h3>{{ num_of_students }}</h3>
                                <h6>Number Of Students</h6>
                            </div>	
                            <div class="mt-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <p class="mb-0">ACADEMIC SESSION</p>
                                    <p class="mb-0" id="academicSession" data-session="{{academic_session.id}}">{{academic_session}}</p>
                                </div>
                            </div>
                            <div class="">
                                <div class="d-flex justify-content-between mb-2">
                                    <p class="mb-0">ACADEMIC TERM</p>
                                    <p class="mb-0" id="academicTerm" data-term="{{academic_term.id}}">{{academic_term.name}}</p>
                                </div>
                            </div>
                            <div class="">
                                <div class="d-flex justify-content-between mb-2">
                                    <p class="mb-0">CLASS</p>
                                    <p class="mb-0" id="studentClass" data-class="{{student_class.id}}">{{student_class}}</p>
                                </div>
                            </div>
                            <div class="">
                                <div class="d-flex justify-content-between mb-2">
                                    <p class="mb-0">CLASS ARM</p>
                                    <p class="mb-0" id="studentClassArm" data-classarm="{{student_class_arm.id}}">{{student_class_arm}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6 col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="ds-head">
                                <h3 class="d-flex align-items-center justify-content-between">$2,000<span class="badge badge-success light ms-2"><i class="fa-solid fa-arrow-up me-2"></i>5.2%
                                    </span></h3>
                                <h6>Total Deposit</h6>
                            </div>
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div id="AllProject_rate"></div>
                                    <ul class="project-list">
                                        <li><h6>All Projects</h6></li>
                                        <li>
                                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect width="10" height="10" rx="3" fill="#3AC977"/>
                                            </svg>
                                            Compete
                                        </li>
                                        <li>
                                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect width="10" height="10" rx="3" fill="var(--primary)"/>
                                            </svg>
                                            Pending
                                        </li>
                                        <li>
                                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect width="10" height="10" rx="3" fill="var(--secondary)"/>
                                            </svg>
                                            Not Start
                                        </li>
                                    </ul>
                                </div>
                                <ul class="ds-prise">
                                    <li>$500</li>
                                    <li>$200</li>
                                    <li>$560</li>
                                </ul>
                                
                            </div>	
                        </div>
                    </div>
                </div>
                <div class="col-xl-6 col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="ds-head">
                                <h6 class="mb-0">Revenue</h6>
                                <h3><small>$</small>310.435</h3>
                            </div>
                            <div class="d-team">
                                <span class="d-block text-black">Our Star</span>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-list avatar-list-stacked">
                                        <img src="images/contacts/pic666.jpg" class="avatar avatar-lg  rounded-circle" alt="">
                                        <img src="images/contacts/pic555.jpg" class="avatar avatar-lg rounded-circle" alt="">
                                        <img src="images/contacts/pic1.jpg" class="avatar avatar-lg rounded-circle" alt="">
                                        <span class="avatar avatar-lg  rounded-circle bg-primary text-white">P</span>
                                        <img src="images/contacts/pic666.jpg" class="avatar avatar-lg  rounded-circle" alt="">
                                        <span class="avatar avatar-lg  rounded-circle bg-danger text-white">H</span>
                                    </div>
                                    <a href="javascript:void(0)">21+ Team</a>
                                </div>
                            </div>	
                        </div>
                    </div>
                </div>
                <div class="col-xl-6 col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="ds-head">
                                <img src="images/uidesgn.png" alt="">
                            </div>
                            <div class="">
                                <h6>UI/UX Design</h6>
                                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry</p>
                                <a href="javascript:void(0);" class="btn btn-primary btn-sm">Learn More</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6 col-xxl-12">
                    <div class="card">
                        <div class="card-header border-0 pb-0 flex-wrap">
                            <h4 class="heading mb-0">SUBJECTS</h4>
                        </div>

                        
                        <div class="card-body px-0 pb-0">
                            <ul class="nav nav-pills success-tab" id="pills-tab" role="tablist">
                                {% for sub in student_class_object.subjects_taught.all %}
                                <li class="nav-item" role="presentation">
                                <button style="padding: 0px;" {% if forloop.counter == 1 %} class="nav-link active" {% else %} class="nav-link" {% endif %} data-series="{{sub.sub_code}}" id="pills-{{sub.sub_code}}-tab" data-bs-toggle="pill" data-bs-target="#pills-{{sub.sub_code}}" type="button" role="tab"  aria-selected="true">
                                    
                                    <span>{{sub.sub_code}}</span>
                                </button>
                                </li>
                                {% endfor %}
                            </ul>
                            <div class="ajax-message">
                                {% comment %} {% for sub in student_class_object.subjects_taught.all %}
                                {% if forloop.counter == 1 %}class="tab-pane fade show active" {% else %}aria-labelledby="pills-{{sub.sub_code}}-tab" {% endcomment %}
                            </div>
                            
                            <div class="tab-content" id="pills-tabContent">
                                {% for sub in student_class_object.subjects_taught.all %}
                                    <div class="tab-pane fade show {% if forloop.counter == 1 %} active {% endif %}" id="pills-{{sub.sub_code}}" role="tabpanel" aria-labelledby="pills-{{sub.sub_code}}-tab" >
                                        <div class="table-responsive">
                                            
                                                <table class="table  card-table border-no success-tbl">
                                                    <thead>
                                                        <tr>
                                                            <th>Name</th>
                                                            <th>1st Test</th>
                                                            <th>2nd Test</th>
                                                            <th>3rd Test</th>
                                                            <th>Examination</th>
                                                            <th>Total</th>
                                                            <th>Grade</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in student_list %}

                                                        {% with subject_results=results_lookup|get_item:sub.id %}
                                                        {% with student_result=subject_results|get_item:student.student.id %}
                                                        {{student_result.result_id}}
                                                        <form class="result-form" method="post" data-student-id="{{student.student.id}}" data-result-id="{{student_result.result_id}}" data-subject-id="{{sub.id}}">
                                                            {% csrf_token %}
                                                            <tr>
                                                                <input id="result-id{{forloop.counter}}" name="result-id" type="hidden" value="{{res_info.result_id}}" />
                                                                <input id="subject-id{{forloop.counter}}" name="subject-id" type="hidden" value="{{res_info.subject_id}}" />
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <img src="images/contacts/pic1.jpg" class="avatar avatar-xl" alt="">
                                                                        <div class="ms-2 cat-name">
                                                                            <p class="mb-0" id="student-info" data-student="{{student.student.id}}">{{student.student}}</p>	
                                                                            <span>{{student.student.admission_number|upper}}</span>
                                                                        </div>	
                                                                    </div>
                                                                </td>
                                                                <td><input name="first-test" type="number" required class="form-control" value="{{student_result.scores.first_test}}" /></td>
                                                                <td><input name="second-test" type="number" required class="form-control" value="{{student_result.scores.second_test}}" /></td>
                                                                <td><input name="third-test" type="number" required class="form-control" value="{{student_result.scores.third_test}}" /></td>
                                                                <td><input name="exam" type="number" required class="form-control" value="{{student_result.scores.exam}}" /></td>
                                                                <td><input name="total" type="number" readonly class="form-control" value="{{student_result.scores.total}}" /></td>
                                                                <td><input name="grade" type="text" readonly class="form-control" value="{{student_result.scores.grade}}" /></td>
                                                                {% comment %} <!-- <td><input id="total_score" name="total_score" readonly {% if sub.id == sub_id %}value="{{result.total_score}}"{% else %}value=""{% endif %} title="{{result.total_score}}" class="form-control" type="number" /></td> --> {% endcomment %}
                                                                <td><button type="submit" title="{{res.last_updated}}" class="btn btn-primary save-btn" id="button-{{result.id}}">Save</button></td>
                                                            </tr>
                                                        </form>
                                                        {% endwith %}
                                                        {% endwith %}
                                                        {% endfor %}
                                                    </tbody>       
                                                </table>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
				</div>
                            
			</div>
		</div>

		
    <script src="{% static 'accounts/js/jquery.min.js' %}"></script>
    <script>

        $(document).ready(function(){
            
            function sendAjaxCall(changedValue, request, selectIdToAppend, selectId, labelText) {
                $.ajax({
                    url: "{% url 'ajax_result_checker' %}",
                    method: 'GET',
                    data: {
                        'changed_value': changedValue,
                        'request': request
                    },
                    success: function(data) {
                        let status = "Success"
                        if (data.requested_data) {
                            let $label = $('<label>', {
                                text: labelText,
                                class: 'form-label'    
                            })

                            /* let $select = $('<select>', {
                                id: selectId,
                                class: 'default-select form-control wide'    
                            }) */

                            let $select = $(selectId)

                            data.requested_data.forEach(term => {
                                $select.append(
                                    $('<option>', {
                                        id: term.id,
                                        value: term.id,
                                        text: term.name,
                                        data: term.arm
                                    })
                                )
                            })
                            $(selectIdToAppend).empty().append($label)
                            $(selectIdToAppend).append($select)
                        }  
                    }
                })
            }
        

            $('#inputSession').on('change', function () {
                let selectedSession = $('#inputSession').val()
                let selectedSessionData = $('#inputSession').attr("data")
                alert(selectedSessionData)
                sendAjaxCall(selectedSession, 'term', '#termSelectContainer', '#inputTerm', 'Academic Term')
            });

            $('#inputTerm').on('change', function () {
                let selectedTerm = $('#inputSession').val()
                let selectedTermData = $('#inputSession').attr("data")
                alert(selectedTerm)
                // sendAjaxCall(selectedSession, 'term', '#termSelectContainer', '#inputTerm', 'Academic Term')
            });

            $('#inputClassCategory').on('change', (function () {
                let selectedCategory = $('#inputClassCategory').val()
                sendAjaxCall(selectedCategory, 'student_class', '#classSelectContainer', '#inputClass', 'Class')
            }));

            $('#inputClass').on('change', (function () {
                alert("Working")
                let selectedClass = $('#inputClass').val()
                alert(selectedClass)
                sendAjaxCall(selectedClass, 'class_arm', '#classArmSelectContainer', 'inputClassArm', 'Class Arm', '--- SELECT CLASS ARM ---')
            }));


            $('.result-form').on('submit', function (e) {
                e.preventDefault();

                const $form = $(this);
                const formData = new FormData(this)
                const $btn = $form.find('.save-btn');

                const firstTest = formData.get("first-test")
                const secondTest = formData.get("second-test")
                const thirdTest = formData.get("third-test")
                const exam = formData.get("exam")
                const payload = {
                    student_id: $form.data('student-id'),
                    subject_id: $form.data('subject-id'),
                    result_id: $form.data('result-id'),

                    first_test: firstTest,
                    second_test: secondTest,
                    third_test: thirdTest,
                    exam: exam,

                    academic_session: $('#academicSession').data('session'),
                    academic_term: $('#academicTerm').data('term'),
                    student_class: $('#studentClass').data('class'),
                    student_class_arm: $('#studentClassArm').data('classarm'),
                };

                $btn.text('Saving...').prop('disabled', true);

                $.ajax({
                    url: "{% url 'ajax_result_updater' %}",
                    method: 'GET',
                    data: payload,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function (data) {
                        if (!data.error) {
                            $form.find('#grade').val(data.grade);
                            $form.find('#total-score').val(data.total);

                            $('.alert-success').addClass('show')
                            $('.ajax-message').html(`<div class="alert alert-success alert-dismissible fade">
                                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="me-2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                                    Result Updated Successfully!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="btn-close">
                                </div>`)

                            $btn.text('Save').prop('disabled', false);
                        } else {
                            $('.ajax-message').html(`<div class="alert alert-error alert-dismissible fade">
                                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="me-2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                                Problem Encountered While Making Request!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="btn-close"></button>
                            </div>`)
                        }
                        
                    },
                    error: function () {
                        $('.ajax-message').html(`<div class="alert alert-error alert-dismissible fade">
                                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="me-2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                                Result Not Updated. Please Try Again!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="btn-close"></button>
                            </div>`)
                        $btn.text('Save').prop('disabled', false);
                    }
                });
            });

            function showRowAlert($form, message, type = 'success') {
                const $alert = $form.find('.row-alert');

                $alert
                    .removeClass('d-none alert-success alert-danger')
                    .addClass(`alert-${type}`)
                    .text(message);

                setTimeout(() => {
                    $alert.addClass('d-none');
                }, 3000);
            }



            
            /* function submitForm(e, formData) {
                e.preventDefault()
                const subjectId = formData.get("subject-id")
                const resultId = formData.get("result-id")
                const firstTest = formData.get("1st-test")
                const secondTest = formData.get("2nd-test")
                const thirdTest = formData.get("3rd-test")
                const exam = formData.get("exam")
                const studentId = $('#student-info').data('student')
                const academicSession = $('#academicSession').data("session")
                const academicTerm = $('#academicTerm').data("term")
                const studentClass = $('#studentClass').data("class")
                const studentClassArm = $('#studentClassArm').data("classarm")
                
                
                $.ajax({
                    url: "{% url 'ajax_result_updater' %}",
                    method: 'GET',
                    data: {
                        "subject_id": subjectId,
                        "result_id": resultId,
                        "first_test": firstTest,
                        "second_test": secondTest,
                        "third_test": thirdTest,
                        "exam": exam,
                        "student_id": studentId,
                        "academic_session": academicSession,
                        "academic_term": academicTerm,
                        "student_class": studentClass,
                        "student_class_arm": studentClassArm,
                    },
                    success: function(data) {
                        $('#grade').attr("value", data.grade);
                        $('#total_score').attr("value", data.total)
                        $('#ajax-message').append(data.html_message)
                        $('.alert').addClass('show')
                        setTimeout(function () {
                            $('.alert').removeClass('show')
                        }, 3000);
                    }
                }) 
            } */

            /* $('input').keyup(function() {
                $(this)
            }) */

        })

    </script>


    {% endblock %}